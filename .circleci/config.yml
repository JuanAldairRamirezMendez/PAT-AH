# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/reference/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#jobs-overview & https://circleci.com/docs/reference/configuration-reference/#jobs
jobs:
  frontend:
    # Specify the execution environment. You can specify an image from Docker Hub or use one of our convenience images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/guides/execution-managed/executor-intro/ & https://circleci.com/docs/reference/configuration-reference/#executor-job
    docker:
      # Specify the version you desire here
      # See: https://circleci.com/developer/images/image/cimg/base
      - image: cimg/node:18.20

    # Ejecutar en la raíz del repositorio; los pasos harán cd al subdirectorio frontend
    working_directory: /home/circleci/project

    # Add steps to the job
    # See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#steps-overview & https://circleci.com/docs/reference/configuration-reference/#steps
    steps:
      # Checkout the code as the first step.
      - checkout
      # Verificar y moverse al directorio frontend
      - run:
          name: Verificar directorio frontend
          command: |
            # Movernos al subdirectorio real donde vive el frontend
            FRONTEND_DIR=Frontend-Huancavelica-Alertas-Agricolas
            if [ ! -d "$FRONTEND_DIR" ]; then
              echo "Error: no se encontró $FRONTEND_DIR en $(pwd)"
              echo "Contenido del repositorio:" && ls -la
              exit 1
            fi
            cd "$FRONTEND_DIR"
            if [ ! -f package.json ]; then
              echo "Error: package.json no existe en $(pwd)"
              echo "Contenido del directorio:" && ls -la
              exit 1
            fi
            echo "Directorio frontend correcto: $(pwd)"
      - run:
          name: Instalar dependencias
          command: |
            cd Frontend-Huancavelica-Alertas-Agricolas
            # Instalar incluidas las devDependencies (vitest y testing libs)
            npm ci --include=dev
      - run:
          name: Ejecutar tests
          command: |
            cd Frontend-Huancavelica-Alertas-Agricolas
            npm test
      - run:
          name: Construir aplicación (producción)
          command: |
            cd Frontend-Huancavelica-Alertas-Agricolas
            npm run build --if-present
      - run:
          name: Empaquetar build en app.jar
          command: |
            cd Frontend-Huancavelica-Alertas-Agricolas
            OUT_DIR=""
            for d in build dist public; do
              if [ -d "$d" ]; then
                OUT_DIR="$d"
                break
              fi
            done
            if [ -z "$OUT_DIR" ]; then
              echo "No se encontró directorio de build (buscado: build, dist, public)"
              exit 1
            fi
            echo "Empaquetando contenido de $OUT_DIR"
            if command -v jar >/dev/null 2>&1; then
              jar cvf app.jar -C "$OUT_DIR" .
            else
              (cd "$OUT_DIR" && zip -r ../app.zip .) && mv app.zip app.jar
            fi
            # mover app.jar a la raíz del workspace para que store_artifacts lo capture
            mv -f app.jar /home/circleci/project/app.jar
      - store_artifacts:
          path: /home/circleci/project/app.jar
          destination: frontend/app.jar

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/guides/orchestrate/workflows/ & https://circleci.com/docs/reference/configuration-reference/#workflows
workflows:
  version: 2
  frontend_ci:
    jobs:
      - frontend