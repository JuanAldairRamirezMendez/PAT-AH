# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/reference/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#jobs-overview & https://circleci.com/docs/reference/configuration-reference/#jobs
jobs:
  frontend:
    # Specify the execution environment. You can specify an image from Docker Hub or use one of our convenience images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/guides/execution-managed/executor-intro/ & https://circleci.com/docs/reference/configuration-reference/#executor-job
    docker:
      # Specify the version you desire here
      # See: https://circleci.com/developer/images/image/cimg/base
      - image: cimg/node:18.20

    # Ejecutar los pasos dentro del directorio del frontend para evitar ENOENT
    working_directory: /home/circleci/project/Frontend-Huancavelica-Alertas-Agricolas

    # Add steps to the job
    # See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#steps-overview & https://circleci.com/docs/reference/configuration-reference/#steps
    steps:
      # Checkout the code as the first step.
      - checkout
      # Verificar directorio frontend
      - run:
          name: Verificar directorio frontend
          command: |
            FRONTEND_DIR=/home/circleci/project/Frontend-Huancavelica-Alertas-Agricolas
            if [ ! -d "$FRONTEND_DIR" ]; then
              echo "Error: no se encontró $FRONTEND_DIR"
              echo "Contenido del repositorio en $(pwd):"
              ls -la
              exit 1
            fi
            echo "Directorio frontend encontrado:"
            ls -la "$FRONTEND_DIR"
      - run:
          name: Instalar dependencias
          command: npm ci
      - run:
          name: Ejecutar tests
          command: npm test
      - run:
          name: Construir aplicación (producción)
          command: npm run build --if-present
      - run:
          name: Empaquetar build en app.jar
          command: |
            # Buscar directorio de salida común (build, dist, public) y empaquetar
            OUT_DIR=""
            for d in build dist public; do
              if [ -d "$d" ]; then
                OUT_DIR="$d"
                break
              fi
            done
            if [ -z "$OUT_DIR" ]; then
              echo "No se encontró directorio de build (buscado: build, dist, public)"
              exit 1
            fi
            echo "Empaquetando contenido de $OUT_DIR"
            if command -v jar >/dev/null 2>&1; then
              jar cvf app.jar -C "$OUT_DIR" .
            else
              (cd "$OUT_DIR" && zip -r ../app.zip .) && mv app.zip app.jar
            fi
      - store_artifacts:
          path: app.jar
          destination: frontend/app.jar

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/guides/orchestrate/workflows/ & https://circleci.com/docs/reference/configuration-reference/#workflows
workflows:
  version: 2
  frontend_ci:
    jobs:
      - frontend